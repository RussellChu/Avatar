<html>
<head>
<meta charset="utf-8">
</head>
<body>
</body>
<script>

var eventDispatcher = (function () {
	var inst = {};
	var map = {};
	var dispose = function () {
		inst = null;
		map = null;
	};
	var add = function ( action, listener ) {
		if ( !map || typeof action !== 'string' || action === '' || typeof listener !== 'function' ) {
			return;
		}
		if ( !map[action] ) {
			map[action] = [];
		}
		
		map[action].push( listener );
	};
	var remove = function ( action, listener ) {
		if ( !map ) {
			return;
		}
		if ( typeof action !== 'string' || action === '' ) {
			map = {};
			return;
		}
		if ( !map[action] ) {
			return;
		}
		if ( typeof listener !== 'function' ) {
			map[action] = [];
			return;
		}
		var i = 0;
		var list = map[action];
		for(i = 0; i < list.length; i++) {
			if ( list[i] === listener ) {
				list.splice( i, 1 );
				return;
			}
		}
	};
	var dispatch = function ( action, data ) {
		if ( !map || typeof action !== 'string' || action === '' || !map[action] ) {
			return;
		}
		var i = 0;
		var list = map[action];
		for(i = 0; i < list.length; i++) {
			var listener = list[i];
			listener( data );
		}
	};
	inst.dispose = dispose;
	inst.add = add;
	inst.dispatch = dispatch;
	inst.remove = remove;
	return inst;
} ());

const ButtonAction = {};
ButtonAction.ADD = 'ADD';
ButtonAction.REMOVE = 'REMOVE';

const GameEvent = {};
GameEvent.BUTTON_CLICKED = 'BUTTON_CLICKED';
GameEvent.SWF_DATA_RECEIVED = 'SWF_DATA_RECEIVED';

const GameData = {};
GameData.BODY_ASSETS = 'base_a000';
GameData.CACHE_DATE = '201709121720';
GameData.LAYER_MAX = 130;
GameData.MOVE_POS = { x: 150, y: 200 };

const AssetName = {
	'basket_z101a': '艾伯李斯特的手提公仔'
};

const AvatarPos = {};

AvatarPos[2] = { x: 13, y: 245 };
AvatarPos[27] = { x: 0, y: 0 }; // Nothing found
AvatarPos[31] = { x: 0, y: 0 }; // Nothing found
AvatarPos[33] = { x: 15, y: 23 };
AvatarPos[34] = { x: 0, y: 99 };
AvatarPos[44] = { x: 12, y: 103 };
AvatarPos[48] = { x: 11, y: 174 };
AvatarPos[51] = { x: 11, y: 242 };
AvatarPos[53] = { x: 22, y: 60 };
AvatarPos[55] = { x: 38, y: 105 };
AvatarPos[59] = { x: 43, y: 172 };
AvatarPos[62] = { x: 53, y: 242 };
AvatarPos[67] = { x: 27, y: 46 };
AvatarPos[81] = { x: 56, y: 103 };
AvatarPos[85] = { x: 53, y: 61 };
AvatarPos[87] = { x: 46, y: 24 };
AvatarPos[97] = { x: 29, y: 0 };

AvatarPos[3] = AvatarPos[2];
AvatarPos[4] = AvatarPos[2];
AvatarPos[8] = AvatarPos[2];
AvatarPos[120] = AvatarPos[2];
AvatarPos[124] = AvatarPos[2];
AvatarPos[125] = AvatarPos[2];
AvatarPos[126] = AvatarPos[2];

AvatarPos[36] = AvatarPos[33];

AvatarPos[42] = AvatarPos[51];
AvatarPos[52] = AvatarPos[51];

AvatarPos[41] = AvatarPos[53];
AvatarPos[43] = AvatarPos[53];
AvatarPos[45] = AvatarPos[53];
AvatarPos[56] = AvatarPos[53];
AvatarPos[64] = AvatarPos[53];
AvatarPos[69] = AvatarPos[53];

AvatarPos[10] = AvatarPos[67]; // Testing
AvatarPos[12] = AvatarPos[67];
AvatarPos[13] = AvatarPos[67]; // Testing
AvatarPos[21] = AvatarPos[67];
AvatarPos[40] = AvatarPos[67];
AvatarPos[72] = AvatarPos[67];
AvatarPos[74] = AvatarPos[67];
AvatarPos[75] = AvatarPos[67];
AvatarPos[77] = AvatarPos[67];
AvatarPos[91] = AvatarPos[67];
AvatarPos[107] = AvatarPos[67];

AvatarPos[78] = AvatarPos[81];
AvatarPos[82] = AvatarPos[81];

AvatarPos[16] = AvatarPos[97];
AvatarPos[17] = AvatarPos[97];
AvatarPos[18] = AvatarPos[97];
AvatarPos[37] = AvatarPos[97];
AvatarPos[94] = AvatarPos[97];
AvatarPos[98] = AvatarPos[97];
AvatarPos[101] = AvatarPos[97];
AvatarPos[102] = AvatarPos[97];
AvatarPos[103] = AvatarPos[97];
AvatarPos[104] = AvatarPos[97];
AvatarPos[105] = AvatarPos[97];
AvatarPos[108] = AvatarPos[97];
AvatarPos[111] = AvatarPos[97];
AvatarPos[112] = AvatarPos[97];
AvatarPos[114] = AvatarPos[97];
AvatarPos[117] = AvatarPos[97];

function onSwfDataReceived( data ) {
	eventDispatcher.dispatch( GameEvent.SWF_DATA_RECEIVED, data );
}

var createAvatar = function () {
	var inst = {};
	
	var swf = null;
	
	var init = function () {
		swf = document.createElement( 'object' );
		swf.setAttribute( 'id', 'avatar' );
		swf.setAttribute( 'type', 'application/x-shockwave-flash' );
		swf.setAttribute( 'data', './assets.swf?t=' + GameData.CACHE_DATE );
		
		swf.style.position = 'absolute';
		swf.style.left = '0px';
		swf.style.top = '0px';
		swf.style.pointerEvents = 'none';
		
		var param = null;
		
		param = document.createElement( 'param' );
		param.setAttribute( 'name', 'allowscriptaccess' );
		param.setAttribute( 'value', 'always' );
		swf.appendChild( param );
		
		param = document.createElement( 'param' );
		param.setAttribute( 'name', 'wmode' );
		param.setAttribute( 'value', 'transparent' );
		swf.appendChild( param );
		
		document.body.appendChild( swf );
	};
	
	var clear = function ( body ) {
		swf.execute( { action: 'clear', body: body } );
	};
	
	var clearLayer = function ( layer, body ) {
		swf.execute( { action: 'clearLayer', layer: layer, body: body } );
	};
	
	var initLayer = function ( layer ) {
		swf.execute( { action: 'init', layer: layer } );
	};
	
	var resize = function ( width, height ) {
		swf.width = '' + width + 'px';
		swf.height = '' + height + 'px';
	};
	
	var setVisible = function ( value ) {
		if ( value ) {
			dom.style.display = 'inline-block';
		} else {
			dom.style.display = 'none';
		}
	};
	
	var show = function ( name, layer, x, y, body ) {
		swf.execute( { action: 'show', name: name, layer: layer, x: x, y: y, body } );
	};
	
	inst.init = init;
	inst.clear = clear;
	inst.clearLayer = clearLayer;
	inst.initLayer = initLayer;
	inst.resize = resize;
	inst.setVisible = setVisible;
	inst.show = show;
	
	return inst;
};

var createButton = function () {
	var inst = {};
	var dom = null;
	
	var onClick = function () {
		eventDispatcher.dispatch( GameEvent.BUTTON_CLICKED, { action: dom.value } );
	};
	
	var init = function ( name, action ) {
		dom = document.createElement( 'button' );
		dom.value = action;
		dom.style.position = 'absolute';
		dom.style.left = '0px';
		dom.style.top = '0px';
		dom.style.width = '150px';
		dom.style.height = '20px';
		var txt = document.createTextNode( name );
		dom.appendChild( txt );
		dom.onclick = onClick;
		document.body.appendChild( dom );
	};
	
	var getInstance = function () {
		return dom;
	};
	
	inst.init = init;
	inst.getInstance = getInstance;
	
	return inst;
};

var createSelectBox = function () {
	var inst = {};
	var dom = null;
	var map = {};
	
	var init = function () {
		dom = document.createElement( 'select' );
		dom.style.position = 'absolute';
		dom.style.left = '0px';
		dom.style.top = '0px';
		dom.style.width = '150px';
		dom.style.height = '20px';
		document.body.appendChild( dom );
	};
	
	var add = function ( value, _caption ) {
		if ( typeof value !== 'string' || !value || map.hasOwnProperty( value ) ) {
			return;
		}
		
		var option = document.createElement( 'option' );
		option.value = value;
		
		var caption = value;
		if ( typeof _caption === 'string' ) {
			caption = _caption;
		}
		var txt = document.createTextNode( caption );
		option.appendChild( txt );
		map[value] = option;
		dom.appendChild( option );
	};
	
	var getInstance = function () {
		return dom;
	};
	
	var getValue = function () {
		return dom.value;
	};
	
	var remove = function ( value ) {
		if ( typeof value !== 'string' || !value || !map.hasOwnProperty( value ) ) {
			return;
		}
		
		var option = map[value];
		dom.removeChild( option );
		
		delete map[value];
	};
	
	var setVisible = function ( value ) {
		if ( value ) {
			dom.style.display = 'inline-block';
		} else {
			dom.style.display = 'none';
		}
	};
	
	inst.init = init;
	inst.add = add;
	inst.getInstance = getInstance;
	inst.getValue = getValue;
	inst.remove = remove;
	inst.setVisible = setVisible;
	
	return inst;
};

var createAvatarModel = function () {
	var inst = {};
	
	var addMap = {};
	var assetsMap = {};
	
	var clear = function () {
	};
	
	var dressing = function ( name ) {
		var rslt = [];
		if ( addMap.hasOwnProperty( name ) || !assetsMap.hasOwnProperty( name ) ) {
			return rslt;
		}
		
		var addData = assetsMap[name];
		
		for(var key in addMap) {
			var item = addMap[key];
			for(var i = 0; i < addData.list.length; i++) {
				var idx = addData.list[i];
				if ( item[idx] === true ) {
					var remove_rslt = undress( key );
					for(var j = 0; j < remove_rslt.length; j++) {
						rslt.push( remove_rslt[j] );
					}
					break;
				}
			}
		}
		
		addMap[name] = {};
		rslt.push( { action: 'add_grp', name: name } );
		
		for(var i = 0; i < addData.list.length; i++) {
			var idx = addData.list[i];
			addMap[name][idx] = true;
			rslt.push( { action: 'add_item', layer: idx, name: name + '_p' + idx, body: ( name === GameData.BODY_ASSETS ) } );
		}
		
		return rslt;
	};
	
	var undress = function ( name ) {
		var rslt = [];
		if ( !addMap.hasOwnProperty( name ) || !assetsMap.hasOwnProperty( name ) ) {
			return rslt;
		}
		
		rslt.push( { action: 'remove_grp', name: name } );
		
		var removeData = assetsMap[name];
		delete addMap[name];
		for(var j = 0; j < removeData.list.length; j++) {
			var idx = removeData.list[j];
			rslt.push( { action: 'clear_layer', layer: idx } );
		}
		
		return rslt;
	};
	
	var setMap = function ( data ) {
		if ( !data || typeof data !== 'object' ) {
			return;
		}
		
		assetsMap = data;
	};
	
	inst.clear = clear;
	inst.dressing = dressing;
	inst.setMap = setMap;
	inst.undress = undress;
	
	return inst;
};

var main = (function () {
	var inst = {};
	var avatar = createAvatar();
	var selectBoxAdd = createSelectBox();
	var selectBoxDel = createSelectBox();
	var btnAdd = createButton();
	var btnDel = createButton();
	var model = createAvatarModel();
	
	var actDressingRslt = function ( rslt ) {
		for(var i = 0; i < rslt.length; i++) {
			var item = rslt[i];
			console.log( '' + JSON.stringify( item ) );
			
			var action = item.action;
			switch ( action ) {
			case 'add_grp':
				var name = item.name;
				if ( name !== GameData.BODY_ASSETS ) {
				var caption = name;
				if ( AssetName.hasOwnProperty( name ) ) {
					caption = AssetName[name];
				}
				selectBoxAdd.add( list[i].name, caption );
					selectBoxDel.add( name );
				}
				break;
			case 'add_item':
				var name = item.name;
				var layer = item.layer;
				var pos = { x: 0, y: 0 };
				if ( AvatarPos.hasOwnProperty( '' + layer ) ) {
					pos = AvatarPos[layer];
				}
				avatar.show( name, layer, GameData.MOVE_POS.x + pos.x, GameData.MOVE_POS.y + pos.y, item.body );
				break;
			case 'clear':
				avatar.clear( false );
				break;
			case 'clear_layer':
				var layer = item.layer;
				avatar.clearLayer( layer, false );
				break;
			case 'remove_grp':
				var name = item.name;
				selectBoxDel.remove( name );
				break;
			}
		}
	};
	
	var sigBtnAdd = function ( value ) {
		console.log( 'sigBtnAdd >> ' + value );
		
		var rslt = model.dressing( value );
		actDressingRslt( rslt );
	};
	
	var sigBtnDel = function ( value ) {
		console.log( 'sigBtnDel >> ' + value );
		
		if ( value === GameData.BODY_ASSETS ) {
			console.log( 'skip >> ' + value );
			return;
		}
		
		var rslt = model.undress( value );
		actDressingRslt( rslt );
	};
	
	var sigSwfInit = function ( data ) {
		if ( !data.hasOwnProperty( 'width' ) || !data.hasOwnProperty( 'height' ) || !data.hasOwnProperty( 'assets' ) ) {
			console.log( 'sigSwfInit failed' );
			return;
		}
	
		console.log( 'sigSwfInit' );
		
		var width = data.width;
		var height = data.height;
		avatar.resize( width, height );
		avatar.initLayer( GameData.LAYER_MAX );
		
		var assetsMap = data.assets;
		model.setMap( assetsMap );
		
		var list = [];
		for(var key in assetsMap) {
			var item = assetsMap[key];
			item.name = key;
			list.push( item );
		}
		
		console.log( 'assets found >> ' + list.length );
		list.sort( function ( a, b ) {
			if ( a.name > b.name ) {
				return 1;
			}
			if ( a.name < b.name ) {
				return -1;
			}
			return 0;
		});
		
		for(var i = 0; i < list.length; i++) {
			if ( list[i].name === GameData.BODY_ASSETS ) {
				continue;
			}
			var caption = list[i].name;
			if ( AssetName.hasOwnProperty( list[i].name ) ) {
				caption = AssetName[list[i].name];
			}
			selectBoxAdd.add( list[i].name, caption );
		}
		
		selectBoxAdd.setVisible( true );
		selectBoxDel.setVisible( true );
		
		sigBtnAdd( GameData.BODY_ASSETS );
	};
	
	var sigSwfLog = function ( data ) {
		if ( data.hasOwnProperty( 'msg' ) ) {
			console.log( 'avatar log :: ' + msg );
		} else {
			console.log( 'sigSwfLog failed' );
		}
	};
	
	var onButtonClicked = function ( data ) {
		if ( !data || !data.hasOwnProperty( 'action' ) ) {
			console.log( 'onButtonClicked failed' );
			return;
		}
		
		var action = data.action;
		switch ( action ) {
		case ButtonAction.ADD:
			sigBtnAdd( selectBoxAdd.getValue() );
			break;
		case ButtonAction.REMOVE:
			sigBtnDel( selectBoxDel.getValue() );
			break;
		default:
			console.log( 'onSwfDataReceived failed, unknown action >> ' + action );
		}
	};
	
	var onSwfDataReceived = function ( data ) {
		if ( !data || !data.hasOwnProperty( 'action' ) ) {
			console.log( 'onSwfDataReceived failed' );
			return;
		}
		
		var action = data.action;
		switch ( action ) {
		case 'init':
			sigSwfInit( data );
			break;
		case 'log':
			sigSwfLog( data );
			break;
		default:
			console.log( 'onSwfDataReceived failed, unknown action >> ' + action );
		}
	};
	
	eventDispatcher.add( GameEvent.BUTTON_CLICKED, onButtonClicked );
	eventDispatcher.add( GameEvent.SWF_DATA_RECEIVED, onSwfDataReceived );
	
	selectBoxAdd.init();
	selectBoxAdd.setVisible( false );
	selectBoxAdd.getInstance().style.top = '20px';
	selectBoxDel.init();
	selectBoxDel.setVisible( false );
	selectBoxDel.getInstance().style.left = '150px';
	selectBoxDel.getInstance().style.top = '20px';
	btnAdd.init( 'Add', ButtonAction.ADD );
	btnDel.init( 'Remove',ButtonAction.REMOVE );
	btnDel.getInstance().style.left = '150px';
	
	avatar.init();
	
} ());

</script>
</html>